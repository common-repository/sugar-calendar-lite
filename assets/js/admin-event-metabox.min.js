!function(i,t){"use strict";var e=window.SugarCalendar||{};e.Admin=e.Admin||{},e.Admin.EventMetabox={init:function(t){this.settings=t,this.$el=i(".sugar-calendar-event-details-metabox"),this.$sectionButtons=i(".sugar-calendar-metabox__navigation__button",this.$el),this.$sections=i(".sugar-calendar-metabox__section",this.$el),this.$startDate=i("#start_date",this.$el),this.$startTimeHour=i("#start_time_hour",this.$el),this.$startTimeMinute=i("#start_time_minute",this.$el),this.$startTimeAmPm=i("#start_time_am_pm",this.$el),this.$startTz=i("#sugar-calendar_start_tz",this.$el),this.$endDate=i("#end_date",this.$el),this.$endTimeHour=i("#end_time_hour",this.$el),this.$endTimeMinute=i("#end_time_minute",this.$el),this.$endTimeAmPm=i("#end_time_am_pm",this.$el),this.$endTz=i("#sugar-calendar_end_tz",this.$el),this.$allDay=i("#all_day",this.$el),this.$timezones=i(".sugar-calendar-metabox__field-row--time-zone, .event-time-zone, .event-time",this.$el),this.$submitButton=i("#publish"),this.bindEvents(),this.initChoicesJS(),this.initDatepickers()},bindEvents:function(){this.$sectionButtons.on("click",this.onSectionButtonClick.bind(this)),this.$allDay.on("change",this.toggleTimezones.bind(this)),this.$submitButton.on("click",this.validateDates.bind(this))},onSectionButtonClick:function(t){var t=i(t.currentTarget),e=t.attr("data-id"),e=this.$sections.filter(`[data-id=${e}]`);this.$sectionButtons.removeClass("selected"),this.$sections.removeClass("selected"),t.addClass("selected"),e.addClass("selected")},initChoicesJS:function(){i(".choicesjs-select",this.$el).each((t,e)=>{new Choices(e,{itemSelectText:""})})},initDatepickers:function(){i("[data-datepicker]",this.$el).datepicker({dateFormat:"yy-mm-dd",firstDay:this.settings.start_of_week,beforeShow:()=>{i("#ui-datepicker-div").removeClass("ui-datepicker").addClass("sugar-calendar-datepicker")}}),this.$startDate.on("change",()=>{var t=this.getDate(this.$startDate.val());this.$endDate.datepicker("option","minDate",t),""===this.$endDate.val()&&this.$endDate.datepicker("setDate",t)}),this.$startTimeHour.on("change",()=>this.adjustTime(this.$startTimeHour,this.$endTimeHour,1)),this.$endTimeHour.on("change",()=>this.adjustTime(this.$endTimeHour,this.$startTimeHour,-1)),this.$startTimeMinute.on("change",()=>{""===this.$endTimeMinute.val()&&this.$endTimeMinute.val(this.$startTimeMinute.val())}),this.$startTimeAmPm.on("change",()=>{""===this.$endTimeAmPm.val()&&this.$endTimeAmPm.val(this.$startTimeAmPm.val())}),this.$endDate.on("change",()=>{this.$startDate.datepicker("option","maxDate",this.getDate(this.$endDate.val())),""===this.$startDate.val()&&this.$startDate.datepicker("setDate",this.$endDate.val())}),this.$endTimeMinute.on("change",()=>{""===this.$startTimeMinute.val()&&this.$startTimeMinute.val(this.$endTimeMinute.val())}),this.$endTimeAmPm.on("change",()=>{""===this.$startTimeAmPm.val()&&this.$startTimeAmPm.val(this.$endTimeAmPm.val())}),this.$startDate.datepicker("option","maxDate",this.getDate(this.$endDate.val())),this.$endDate.datepicker("option","minDate",this.getDate(this.$startDate.val())),"object"==typeof wp.blockEditor&&i.each([this.startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm],function(t,e){i(e).on("change",this.blockEditorDateValidation.bind(this))}.bind(this))},getDate:function(e){try{e=i.datepicker.parseDate("yy-mm-dd",e)}catch(t){e=null}return e},toggleTimezones:function(){this.$allDay.prop("checked")?this.$timezones.hide():this.$timezones.show()},adjustTime(e,i,a){if(""===i.val()){var s=parseInt(sugar_calendar_admin_event_meta_box.clock_type,10);let t=(parseInt(e.val(),10)+a+s)%s;12===s&&0===t&&(t=12),i.val(t.toString().padStart(2,"0"))}},isStartEndInvalid:function(){var t,e;return("multi"!==this.settings.timezone_type||this.$startTz.val()===this.$endTz.val())&&(t=this.getEventDateTime(this.$startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$startTz),(e=this.getEventDateTime(this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm,0<this.$endTz.length?this.$endTz:this.$startTz)).isBefore(t)||e.isSame(t))},validateDates:function(t){!1===this.$allDay.prop("checked")&&this.isStartEndInvalid()&&(t.preventDefault(),this.$sectionButtons.filter("[data-id=duration]").click(),this.$sections.filter("[data-id=duration]").addClass("sugar-calendar-field-dates-invalid"))},getEventDateTime:function(t,e,i,a,s){var n=sugar_calendar_admin_event_meta_box.clock_type,r=moment().format("YYYY-MM-DD"),t=t&&t.val()||r,r=e&&e.val()||"01",e=i&&i.val()||"00",i="12"===n&&a?a.val()||"AM":"",a=s&&s.val()||"";return this.createMomentObject(t,r,e,i,n,a)},createMomentObject(t,e,i,a,s,n){let r=parseInt(e,10),h=parseInt(i,10);"12"===s&&a&&("pm"===(e=a.toLowerCase())&&12!==r?r+=12:"am"===e&&12===r&&(r=0)),"24"===s&&(r=Math.min(Math.max(r,0),23)),h=Math.min(Math.max(h,0),59);i=`${t} ${r.toString().padStart(2,"0")}:`+h.toString().padStart(2,"0");return moment.tz(i,"YYYY-MM-DD HH:mm",n)},blockEditorDateValidation:function(){var t,e,i;""!==this.$startDate.val()&&""!==this.$startTimeHour.val()&&""!==this.$endDate.val()&&""!==this.$endTimeHour.val()&&(t=this.getEventDateTime(this.$startDate,this.$startTimeHour,this.$startTimeMinute,this.$startTimeAmPm,this.$startTz),e=this.getEventDateTime(this.$endDate,this.$endTimeHour,this.$endTimeMinute,this.$endTimeAmPm,this.$endTz),i="invalid-date-error",this.isStartEndInvalid()?(wp.data.dispatch("core/editor").lockPostSaving(i),wp.data.dispatch("core/notices").createNotice("error",wp.i18n.__("End date and time cannot be before the start date and time.","sugar-calendar"),{id:i,isDismissible:!0})):e.isAfter(t)&&(wp.data.dispatch("core/editor").unlockPostSaving(i),wp.data.dispatch("core/notices").removeNotice(i)))}},e.Admin.EventMetabox.init(t),window.SugarCalendar=e}(jQuery,sugar_calendar_admin_event_meta_box);