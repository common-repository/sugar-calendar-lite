"use strict";var sugar_calendar=window.sugar_calendar||function(r,s){function d(e){e.find(".sugar-calendar-block__popover").removeClass("sugar-calendar-block__controls__settings__btn_active").hide(),e.find(".sugar-calendar-block__controls__settings__btn").removeClass("sugar-calendar-block__controls__settings__btn_active"),e.find(".sugar-calendar-block__controls__left__date").removeClass("sugar-calendar-block__controls__settings__btn_active"),s("body").removeClass("sugar-calendar-block__popovers__active")}Array.prototype.uniquePush=function(e){return this.includes(e)||this.push(e),this};function a(e,a){this.$popover=e,this.$mainContainer=a}function t(n){this.$mainContainer=n;let t=[{key:"month_selector",popover_selector:".sugar-calendar-block__popover__month_selector",button_selector:".sugar-calendar-block__controls__left__date"},{key:"calendar_selector",popover_selector:".sugar-calendar-block__popover__calendar_selector",button_selector:".sugar-calendar-block__controls__right__settings__btn"},{key:"display_selector",popover_selector:".sugar-calendar-block__popover__display_selector",button_selector:".sugar-calendar-block__controls__right__view__btn"}],o=this;t.forEach(e=>{var a=n.find(e.button_selector);a.on("click",o.toggle.bind(o,a,e.key,t))})}function e(e){this.calendarBlock=e}function n(e){this.$mainContainer=e,this.$formContainer=e.find(".sugar-calendar-block-settings"),this.$mobileListContainer=e.find(".sugar-calendar-block__mobile_event_list"),this.id=this.$formContainer.find('input[name="sc_calendar_id"]').val(),this.$searchContainer=e.find(".sugar-calendar-block__controls__right__search__field"),this.$searchClear=e.find(".sugar-calendar-block__controls__right__search__clear"),this.$timeOfDayContainer=e.find(".sugar-calendar-block__popover__calendar_selector__container__time"),this.$daysOfWeekContainer=e.find(".sugar-calendar-block__popover__calendar_selector__container__days"),this.$datePicker=e.find(".sugar-calendar-block__controls__datepicker"),void 0!==this.id&&0<this.id.length&&(this.initPopovers(),this.initControls(),this.initDatePicker()),1===parseInt(this.$formContainer.find('input[name="sc_visitor_tz_convert"]').val())&&this.update()}let h=null,o=(a.prototype.show=function(e){var a=s(e.target);let n;a=(n=a.hasClass("sugar-calendar-block__event-cell")?a:s(e.target).parents(".sugar-calendar-block__event-cell")).data("eventobjid");let t=this.$popover.find(".sugar-calendar-block__popover__event__container__image"),o=this.$popover.find(".sugar-calendar-block__popover__event__container__content__description");t.hide(),t.css("background-image",""),o.text(""),void 0!==a&&(o.prepend('<div class="sugar-calendar-block__loading sugar-calendar-block__loading--no-overlay"></div>'),s.post(sugar_calendar_obj.ajax_url,{action:"sugar_calendar_event_popover",event_object_id:a,nonce:sugar_calendar_obj.nonce},function(e){if(e.success&&e.data){e.data.image&&(t.css("background-image",`url(${e.data.image})`),t.show());let n=[];e.data.description&&(e=s.parseHTML(e.data.description.trim()),s.each(e,function(e,a){n.push(a.textContent)})),o.html(""),o.text(n.join(""))}}));var e=n.find(".sugar-calendar-block__event-cell__title").text().trim(),a=n.find(".sugar-calendar-block__event-cell__time").text().trim(),r=this.$popover.find(".sugar-calendar-block__popover__event__container__content__title__link");r.attr("href",n.data("eventurl")),r.text(e);let l=Intl.DateTimeFormat().resolvedOptions().timeZone,i="",_=n.data("daydate");"undefined"!=typeof SCTimeZones&&l.length?(i=wp.date.dateI18n(SCTimezoneConvert.date_format,_.start_date.datetime,l),_.end_date&&(i+=" - "+wp.date.dateI18n(SCTimezoneConvert.date_format,_.end_date.datetime,l))):(i=_.start_date.value,_.end_date&&(i+=" - "+_.end_date.value)),this.$popover.find(".sugar-calendar-block__popover__event__container__content__date").text(i),this.$popover.find(".sugar-calendar-block__popover__event__container__content__time").text(a);r=this.$popover.find(".sugar-calendar-block__popover__event__container__content__calendar");r.html("");let c=n.data("calendarsinfo");if(void 0!==c&&void 0!==c.calendars){let a=[];c.calendars.forEach(e=>{a.push(`<div style="border-left: 2px solid ${e.color||c.primary_event_color};" class="sugar-calendar-block__popover__event__container__content__calendar__item">${e.name}</div>`)}),r.html(a.join(""))}h.computePosition(n[0],this.$popover[0],{placement:"bottom-start",middleware:[h.offset(10),h.flip(),h.shift()]}).then(({x:e,y:a})=>{Object.assign(this.$popover[0].style,{left:e+"px",top:a+"px"})}),d(this.$mainContainer),this.$popover.show(),s("body").addClass("sugar-calendar-block__popovers__active")},t.prototype.toggle=function(e,a,n){n=n.find(e=>e.key===a),n=this.$mainContainer.find(n.popover_selector);n.is(":visible")?d(this.$mainContainer):(d(this.$mainContainer),this.show(e,n,a))},t.prototype.show=function(e,n,a){var t=r.innerWidth<768,o=[h.offset(10),h.shift()];t?e[0].scrollIntoView({behavior:"smooth"}):o.push(h.flip()),h.computePosition(e[0],n[0],{placement:"calendar_selector"===a?"bottom-end":"bottom-start",middleware:o}).then(({x:e,y:a})=>{Object.assign(n[0].style,{left:e+"px",top:a+"px"})}),e.addClass("sugar-calendar-block__controls__settings__btn_active"),n.show(),s("body").addClass("sugar-calendar-block__popovers__active")},e.prototype.onSearch=function(e){13===e.keyCode?this.calendarBlock.update():0<e.target.value.length?this.calendarBlock.$searchClear.show():this.calendarBlock.$searchClear.hide()},e.prototype.onSearchClick=function(e){this.calendarBlock.update()},e.prototype.onClearSearch=function(e){this.calendarBlock.$searchContainer.val(""),this.calendarBlock.$searchClear.hide(),this.calendarBlock.update()},e.prototype.goToMonth=function(e){this.calendarBlock.$formContainer.find('input[name="sc_month"]').val(parseInt(e.target.dataset.month)),this.calendarBlock.update()},e.prototype.goToPrevious=function(){switch(this.calendarBlock.getDisplay()){case"day":this.calendarBlock.update(!1,"previous_day");break;case"week":this.calendarBlock.update(!1,"previous_week");break;case"month":this.calendarBlock.update(!1,"previous_month")}},e.prototype.goToNext=function(){switch(this.calendarBlock.getDisplay()){case"day":this.calendarBlock.update(!1,"next_day");break;case"week":this.calendarBlock.update(!1,"next_week");break;case"month":this.calendarBlock.update(!1,"next_month")}},e.prototype.onSelectCalendar=function(){this.calendarBlock.update()},e.prototype.onSelectCurrent=function(){this.calendarBlock.$formContainer.find('input[name="sc_month"]').val(this.calendarBlock.$mainContainer.data("ogmonth")),this.calendarBlock.$formContainer.find('input[name="sc_year"]').val(this.calendarBlock.$mainContainer.data("ogyear")),this.calendarBlock.$formContainer.find('input[name="sc_day"]').val(this.calendarBlock.$mainContainer.data("ogday")),this.calendarBlock.update()},e.prototype.onChangeDisplay=function(e){var e=s(e.target).text().trim(),a=e.toLowerCase();a!==this.calendarBlock.getDisplay()&&(this.calendarBlock.$mainContainer.removeClass(`sugar-calendar-block__${this.calendarBlock.getDisplay()}-view`),this.calendarBlock.$mainContainer.addClass(`sugar-calendar-block__${a}-view`),this.calendarBlock.$formContainer.find('input[name="sc_display"]').val(a),this.calendarBlock.update(!0),this.calendarBlock.$mainContainer.find(".sugar-calendar-block__controls__right__view__btn span").text(e))},n.prototype.initDatePicker=function(){void 0!==this.$datePicker&&this.$datePicker.datepicker("destroy");let e=0,a=("month"===this.getDisplay()&&(e=1),this.$datePicker.datepicker({minViewMode:e,maxViewMode:2,templates:{leftArrow:'<svg width="6" height="11" viewBox="0 0 6 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.41406 10.6094C5.29688 10.7266 5.13281 10.7266 5.01562 10.6094L0.09375 5.71094C0 5.59375 0 5.42969 0.09375 5.3125L5.01562 0.414062C5.13281 0.296875 5.29688 0.296875 5.41406 0.414062L5.88281 0.859375C5.97656 0.976562 5.97656 1.16406 5.88281 1.25781L1.64062 5.5L5.88281 9.76562C5.97656 9.85938 5.97656 10.0469 5.88281 10.1641L5.41406 10.6094Z" fill="currentColor"/></svg>',rightArrow:'<svg width="6" height="11" viewBox="0 0 6 11" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.5625 0.414062C0.679688 0.296875 0.84375 0.296875 0.960938 0.414062L5.88281 5.3125C5.97656 5.42969 5.97656 5.59375 5.88281 5.71094L0.960938 10.6094C0.84375 10.7266 0.679688 10.7266 0.5625 10.6094L0.09375 10.1641C0 10.0469 0 9.85938 0.09375 9.76562L4.33594 5.5L0.09375 1.25781C0 1.16406 0 0.976562 0.09375 0.859375L0.5625 0.414062Z" fill="currentColor"/></svg>'},weekStart:sugar_calendar_obj.settings.sow}),this.$formContainer.find('input[name="sc_year"]')),n=this.$formContainer.find('input[name="sc_month"]'),t=this.$formContainer.find('input[name="sc_day"]');this.$datePicker.datepicker("update",new Date(a.val(),n.val()-1,t.val())),this.$datePicker.on("changeDate",e=>{a.val(e.date.getFullYear()),n.val(e.date.getMonth()+1),"month"!==this.getDisplay()&&t.val(e.date.getDate()),this.update()})},n.prototype.initPopovers=function(){let n=this.$mainContainer;new t(n);var e=n.find(".sugar-calendar-block__popover__event"),e=new a(e,n);768<=r.innerWidth?n.on("click",".sugar-calendar-block__event-cell",e.show.bind(e)):n.on("click",".sugar-calendar-block__calendar-week__header__cell",function(e){let a=s(e.target);(a=a.hasClass("sugar-calendar-block__calendar-week__header__cell")?a:a.parents(".sugar-calendar-block__calendar-week__header__cell")).hasClass("sugar-calendar-block__calendar-week__header__cell--active")||void 0===a.data("weekdaynum")||(n.find(".sugar-calendar-block__calendar-week__header__cell--active").removeClass("sugar-calendar-block__calendar-week__header__cell--active"),n.find(".sugar-calendar-block__calendar-week__time-grid__day-col--active").removeClass("sugar-calendar-block__calendar-week__time-grid__day-col--active"),n.find(".sugar-calendar-block__calendar-week__event-slot--all-day--active").removeClass("sugar-calendar-block__calendar-week__event-slot--all-day--active"),a.addClass("sugar-calendar-block__calendar-week__header__cell--active"),n.find(".sugar-calendar-block__calendar-week__event-slot--all-day--"+a.data("weekdaynum")).addClass("sugar-calendar-block__calendar-week__event-slot--all-day--active"),n.find(".sugar-calendar-block__calendar-week__time-grid__day-col-"+a.data("weekdaynum")).addClass("sugar-calendar-block__calendar-week__time-grid__day-col--active"))})},n.prototype.initControls=function(){this.controlEvents=new e(this),this.$searchContainer.on("keyup",this.controlEvents.onSearch.bind(this.controlEvents)),this.$searchClear.on("click",this.controlEvents.onClearSearch.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__right__search__icon").on("click",this.controlEvents.onSearchClick.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__popover__month_selector__container__body__month").on("click",this.controlEvents.goToMonth.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__prev").on("click",this.controlEvents.goToPrevious.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__next").on("click",this.controlEvents.goToNext.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__current").on("click",this.controlEvents.onSelectCurrent.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__cal").on("change",this.controlEvents.onSelectCalendar.bind(this.controlEvents)),this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__day").on("change",this.displayEvents.bind(this)),this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__time").on("change",this.displayEvents.bind(this)),this.$mainContainer.find(".sugar-calendar-block__popover__display_selector__container__body__option").on("click",this.controlEvents.onChangeDisplay.bind(this.controlEvents)),r.innerWidth<768&&(this.$mainContainer.on("click",".sugar-calendar-block__calendar-month__body__day",this.showMobileEvents.bind(this)),this.$mainContainer.on("click",".sugar-calendar-block__mobile_event_list .sugar-calendar-block__event-cell",this.onMobileEventCellClicked.bind(this)),this.$mainContainer.on("click",".sugar-calendar-block__calendar-week__event-slot .sugar-calendar-block__event-cell",this.onMobileEventCellClicked.bind(this)),this.$mainContainer.on("click",".sugar-calendar-block__calendar-day .sugar-calendar-block__event-cell",this.onMobileEventCellClicked.bind(this)))},n.prototype.onMobileEventCellClicked=function(e){let a=s(e.target);(a=a.hasClass("sugar-calendar-block__event-cell")?a:a.parents(".sugar-calendar-block__event-cell")).data("eventurl")&&(r.location.href=a.data("eventurl"))},n.prototype.getCalendarIds=function(){let e=[];return this.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__cal:checked").each(function(){e.push(s(this).val())}),e},n.prototype.getCalendarsFilter=function(){var e=this.$formContainer.find('input[name="sc_calendars_filter"]');return e.length<=0||(e=e.val()).length<=0?[]:e.split(",")},n.prototype.getDisplay=function(){return this.$formContainer.find('input[name="sc_display"]').val()},n.prototype.update=function(e=!1,a=""){d(this.$mainContainer);let n=this.$mainContainer.find(".sugar-calendar-block__base-container"),t=(n.addClass("sugar-calendar-block__loading-state"),n.prepend('<div class="sugar-calendar-block__base-container__overlay"><div class="sugar-calendar-block__loading"></div></div>'),this);e={id:this.id,calendars:this.getCalendarIds(),calendarsFilter:this.getCalendarsFilter(),day:parseInt(this.$formContainer.find('input[name="sc_day"]').val()),month:parseInt(this.$formContainer.find('input[name="sc_month"]').val()),year:parseInt(this.$formContainer.find('input[name="sc_year"]').val()),search:this.$searchContainer.val(),accentColor:this.$mainContainer.data("accentcolor")?this.$mainContainer.data("accentcolor"):"",display:this.getDisplay(),visitor_tz_convert:parseInt(this.$formContainer.find('input[name="sc_visitor_tz_convert"]').val()),visitor_tz:Intl.DateTimeFormat().resolvedOptions().timeZone,updateDisplay:e,action:a};s.post(sugar_calendar_obj.ajax_url,{action:"sugar_calendar_block_update",calendar_block:e,nonce:sugar_calendar_obj.nonce},function(a){if(a.success){t.$formContainer.find('input[name="sc_day"]').val(a.data.date.day),t.$formContainer.find('input[name="sc_month"]').val(a.data.date.month),t.$formContainer.find('input[name="sc_year"]').val(a.data.date.year);let e="";switch(t.getDisplay()){case"day":t.$mainContainer.find(".sugar-calendar-block__view-heading").text(a.data.heading),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").hide(),a.data.is_update_display&&(t.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__days").hide(),e=sugar_calendar_obj.strings.today);break;case"week":t.$mainContainer.find(".sugar-calendar-block__view-heading").text(a.data.heading),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").hide(),a.data.is_update_display&&(t.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__days").show(),t.$mobileListContainer.hide(),e=sugar_calendar_obj.strings.this_week);break;default:t.$mainContainer.find(".sugar-calendar-block__view-heading").text(a.data.heading),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").text(a.data.date.year),t.$mainContainer.find(".sugar-calendar-block__view-heading--year").show(),a.data.is_update_display?(t.$mainContainer.find(".sugar-calendar-block__popover__calendar_selector__container__days").show(),t.$mobileListContainer.show(),e=sugar_calendar_obj.strings.this_month):(t.$mainContainer.find(".sugar-calendar-block__base-container__overlay").remove(),n.removeClass("sugar-calendar-block__loading-state"),n=t.$mainContainer.find(".sugar-calendar-block__calendar-month__body"))}""!==e&&t.$mainContainer.find(".sugar-calendar-block__controls__left__pagination__current").text(e),n.html(a.data.body),n.removeClass("sugar-calendar-block__loading-state"),t.displayEvents(),a.data.is_update_display?t.initDatePicker():t.$datePicker.datepicker("update",new Date(a.data.date.year,a.data.date.month-1,a.data.date.day)),"undefined"!=typeof SCTimeZones&&SCTimeZones.convertEventsTime()}})},n.prototype.getTimeOfDay=function(){return this.$timeOfDayContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__time:checked").map((e,a)=>a.value).get()},n.prototype.getDaysOfWeek=function(){return this.$daysOfWeekContainer.find(".sugar-calendar-block__popover__calendar_selector__container__options__val__day:checked").map((e,a)=>a.value).get()},n.prototype.showMobileEvents=function(e){var a=this.$mobileListContainer.find(".sugar-calendar-block__mobile_event_list__date"),n=this.$mobileListContainer.find(".sugar-calendar-block__mobile_event_list__events_container"),t=(a.html(""),n.html(""),s(e.target));let o;t=(o=t.hasClass("sugar-calendar-block__calendar-month__body__day")?t:s(e.target).parents(".sugar-calendar-block__calendar-month__body__day")).find(".sugar-calendar-block__calendar-month__body__day__events-container");let r=o.data("offsetmonth");(void 0===r||r.length<=0)&&(r=this.$mainContainer.find(".sugar-calendar-block__view-heading").text());var e=sugar_calendar_obj.strings.events_on,l=o.find(".sugar-calendar-block__calendar-month__body__day__number").text().trim();let i=e.replace("[Month Date]",r);l&&(i=i+" "+l),a.text(i),n.html(t.clone()),this.$mobileListContainer.show()},n.prototype.displayEvents=function(){if("week"===this.getDisplay())this.displayEventsOnWeekDisplay();else if("day"===this.getDisplay())this.displayEventsOnDayDisplay();else{let t=this.getTimeOfDay(),o=this.getDaysOfWeek(),r=[],l=this.$mainContainer.find(".sugar-calendar-block__calendar-month");l.find(".sugar-calendar-block__calendar-month__body__day__events-container").each((e,a)=>{let n=s(a);n.find(".sugar-calendar-block__event-cell").each((e,a)=>{a=s(a);(0===o.length||0<s(o).filter([n.data("weekday").toString()]).length)&&(0===t.length||0<s(t).filter(a.data("daydiv")).length)?(a.removeClass("sugar-calendar-block__calendar-month__cell-hide"),r.push(a.data("eventid"))):(a.addClass("sugar-calendar-block__calendar-month__cell-hide"),l.find(".sugar-calendar-block__calendar-month__spacer-eventid-"+a.data("eventid")).addClass("sugar-calendar-block__calendar-month__cell-hide"))})}),r.forEach(e=>{l.find(".sugar-calendar-block__calendar-month__body__day__events-container__event-id-"+e).removeClass("sugar-calendar-block__calendar-month__cell-hide"),l.find(".sugar-calendar-block__calendar-month__spacer-eventid-"+e).removeClass("sugar-calendar-block__calendar-month__cell-hide")})}},n.prototype.filterDisplayWeekView=function(e,n,t,o,r=!1){let l=[];return this.$mainContainer.find(e).each((e,a)=>{a=s(a);0===t.length||0<s(t).filter([a.data("weekday").toString()]).length?a.find(n).each((e,a)=>{a=s(a);0===o.length||0<s(o).filter(a.data("daydiv")).length?r?l.uniquePush(a.data("eventid")):a.removeClass("sugar-calendar-block__calendar-month__cell-hide"):a.addClass("sugar-calendar-block__calendar-month__cell-hide")}):a.find(n).addClass("sugar-calendar-block__calendar-month__cell-hide")}),l},n.prototype.displayEventsOnWeekDisplay=function(){var e=this.getDaysOfWeek(),a=this.getTimeOfDay();this.filterDisplayWeekView(".sugar-calendar-block__calendar-week__event-slot--all-day",".sugar-calendar-block__calendar-week__event-cell--all-day",e,a,!0).forEach(e=>{this.$mainContainer.find(".sugar-calendar-block__calendar-week__event-cell--id-"+e).removeClass("sugar-calendar-block__calendar-month__cell-hide")}),this.filterDisplayWeekView(".sugar-calendar-block__calendar-week__time-grid__day-col",".sugar-calendar-block__calendar-week__event-cell",e,a)},n.prototype.displayEventsOnDayDisplay=function(){let n=this.getTimeOfDay();0===n.length?this.$mainContainer.find(".sugar-calendar-block__event-cell").removeClass("sugar-calendar-block__calendar-month__cell-hide"):this.$mainContainer.find(".sugar-calendar-block__event-cell").each((e,a)=>{a=s(a);0<s(n).filter(a.data("daydiv")).length?a.removeClass("sugar-calendar-block__calendar-month__cell-hide"):a.addClass("sugar-calendar-block__calendar-month__cell-hide")})},{init:function(){s(r).on("load",function(){o.load()})},load:function(){void 0!==r.FloatingUIDOM&&(h=r.FloatingUIDOM,o.initCalendars(),s("body").on("click",o.closePopoversOnBodyClick))},initCalendars:function(){s(".sugar-calendar-block").each(function(){new n(s(this))})},closePopoversOnBodyClick:function(e){var a=s(this);!a.hasClass("sugar-calendar-block__popovers__active")||(e=s(e.target)).hasClass("sugar-calendar-block__controls__left__date")||e.hasClass("sugar-calendar-block__controls__right__settings__btn")||e.hasClass("sugar-calendar-block__controls__right__view__btn")||e.hasClass("sugar-calendar-block__event-cell")||e.hasClass("sugar-calendar-block__popover")||0<e.parents(".sugar-calendar-block__controls__left__date").length||0<e.parents(".sugar-calendar-block__controls__right__settings__btn").length||0<e.parents(".sugar-calendar-block__controls__right__view__btn").length||0<e.parents(".sugar-calendar-block__event-cell").length||0<e.parents(".sugar-calendar-block__popover").length||d(a)}});return o}((document,window),jQuery);sugar_calendar.init();